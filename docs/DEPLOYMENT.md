# Guia de Deployment - Dalivim

## üì¶ Deployment com Docker

### Pr√©-requisitos
- Docker 20.10+
- Docker Compose 2.0+
- 2GB RAM m√≠nimo
- 10GB espa√ßo em disco

### Quick Start

```bash
# 1. Clone o reposit√≥rio
git clone https://github.com/yourusername/dalivim.git
cd dalivim

# 2. Configure vari√°veis de ambiente
cp backend/.env.example backend/.env
# Edite o arquivo .env conforme necess√°rio

# 3. Suba todos os servi√ßos
docker-compose up -d

# 4. Verifique os logs
docker-compose logs -f

# 5. Acesse a aplica√ß√£o
# Frontend: http://localhost:3000
# Backend: http://localhost:8080
# Piston: http://localhost:2000
```

### Servi√ßos Dispon√≠veis

| Servi√ßo | Porta | URL |
|---------|-------|-----|
| Frontend | 3000 | http://localhost:3000 |
| Backend API | 8080 | http://localhost:8080 |
| PostgreSQL | 5432 | localhost:5432 |
| Piston | 2000 | http://localhost:2000 |
| Redis | 6379 | localhost:6379 |

### Comandos √öteis

```bash
# Parar todos os servi√ßos
docker-compose down

# Parar e remover volumes (‚ö†Ô∏è apaga dados)
docker-compose down -v

# Rebuild de servi√ßos
docker-compose up -d --build

# Ver logs de um servi√ßo espec√≠fico
docker-compose logs -f backend

# Executar comando no container
docker-compose exec backend sh

# Ver status dos containers
docker-compose ps

# Restart de um servi√ßo
docker-compose restart backend
```

## üöÄ Deployment em Produ√ß√£o

### 1. Deploy no VPS (Ubuntu 22.04)

#### Instala√ß√£o Inicial

```bash
# Atualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Instalar Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Adicionar usu√°rio ao grupo docker
sudo usermod -aG docker $USER
newgrp docker

# Instalar nginx (reverse proxy)
sudo apt install nginx -y

# Instalar certbot (SSL)
sudo apt install certbot python3-certbot-nginx -y
```

#### Configura√ß√£o do Projeto

```bash
# Clone o projeto
cd /var/www
sudo git clone https://github.com/yourusername/dalivim.git
cd dalivim

# Configure vari√°veis de ambiente para produ√ß√£o
sudo nano backend/.env
```

**backend/.env (produ√ß√£o):**
```env
DB_HOST=postgres
DB_PORT=5432
DB_USER=dalivim_user
DB_PASSWORD=SUPER_SECURE_PASSWORD_HERE
DB_NAME=dalivim_prod
DB_SSLMODE=require

SERVER_PORT=8080
SERVER_HOST=0.0.0.0

JWT_SECRET=GENERATE_A_STRONG_SECRET_KEY_HERE
JWT_EXPIRATION_HOURS=24

ALLOWED_ORIGINS=https://dalivim.com,https://www.dalivim.com

PISTON_API_URL=http://piston:2000

LOG_LEVEL=info
LOG_FORMAT=json
```

#### Suba os containers

```bash
# Build e start
sudo docker-compose -f docker-compose.prod.yml up -d

# Verifique se est√° rodando
sudo docker-compose ps
```

#### Configure Nginx como Reverse Proxy

```bash
sudo nano /etc/nginx/sites-available/dalivim
```

**Configura√ß√£o Nginx:**
```nginx
upstream backend {
    server localhost:8080;
}

upstream frontend {
    server localhost:3000;
}

server {
    listen 80;
    server_name dalivim.com www.dalivim.com;

    # Redirect to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name dalivim.com www.dalivim.com;

    # SSL certificates (will be generated by certbot)
    ssl_certificate /etc/letsencrypt/live/dalivim.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dalivim.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Frontend
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Backend API
    location /api {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;

        # Increase timeout for code execution
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Client max body size (for file uploads)
    client_max_body_size 10M;

    # Logging
    access_log /var/log/nginx/dalivim_access.log;
    error_log /var/log/nginx/dalivim_error.log;
}
```

#### Ative a configura√ß√£o

```bash
# Criar link simb√≥lico
sudo ln -s /etc/nginx/sites-available/dalivim /etc/nginx/sites-enabled/

# Teste a configura√ß√£o
sudo nginx -t

# Restart nginx
sudo systemctl restart nginx
```

#### Configure SSL com Let's Encrypt

```bash
# Gerar certificados SSL
sudo certbot --nginx -d dalivim.com -d www.dalivim.com

# Certbot vai configurar automaticamente o nginx
# Escolha a op√ß√£o de redirect para HTTPS

# Teste auto-renewal
sudo certbot renew --dry-run
```

### 2. Deploy no AWS

#### EC2 + RDS

**Arquitetura:**
- EC2 para Frontend + Backend (Docker)
- RDS PostgreSQL para Database
- S3 para assets est√°ticos (opcional)
- CloudFront para CDN (opcional)

**Passos:**

```bash
# 1. Criar EC2 instance (t3.medium ou maior)
# 2. Configurar Security Group:
#    - SSH (22) - Seu IP
#    - HTTP (80) - 0.0.0.0/0
#    - HTTPS (443) - 0.0.0.0/0
#    - Custom TCP (8080) - Security Group do EC2

# 3. Criar RDS PostgreSQL
#    - Engine: PostgreSQL 15
#    - Instance: db.t3.micro (dev) ou db.t3.small (prod)
#    - Storage: 20GB
#    - Public access: No
#    - VPC: Mesmo da EC2

# 4. SSH no EC2
ssh -i your-key.pem ubuntu@your-ec2-ip

# 5. Instalar Docker (ver se√ß√£o anterior)

# 6. Clone projeto e configure
cd /home/ubuntu
git clone https://github.com/yourusername/dalivim.git
cd dalivim

# 7. Configure .env com RDS endpoint
nano backend/.env

# DB_HOST=your-rds-endpoint.amazonaws.com
# DB_PORT=5432
# DB_USER=postgres
# DB_PASSWORD=your-rds-password
# DB_NAME=dalivim

# 8. Suba os containers
docker-compose up -d

# 9. Configure nginx e SSL (ver se√ß√£o anterior)
```

### 3. Deploy no Heroku

#### Backend (Go)

```bash
# 1. Instalar Heroku CLI
curl https://cli-assets.heroku.com/install.sh | sh

# 2. Login
heroku login

# 3. Criar app
heroku create dalivim-backend

# 4. Adicionar PostgreSQL
heroku addons:create heroku-postgresql:mini

# 5. Configurar buildpack
heroku buildpacks:set heroku/go

# 6. Deploy
cd backend
git init
git add .
git commit -m "Initial commit"
heroku git:remote -a dalivim-backend
git push heroku main

# 7. Configurar vari√°veis
heroku config:set JWT_SECRET=your-secret
heroku config:set ALLOWED_ORIGINS=https://dalivim-frontend.vercel.app
```

#### Frontend (React) no Vercel

```bash
# 1. Instalar Vercel CLI
npm i -g vercel

# 2. Login
vercel login

# 3. Deploy
cd frontend
vercel

# 4. Configurar vari√°veis de ambiente
vercel env add REACT_APP_API_URL production
# Insira: https://dalivim-backend.herokuapp.com

# 5. Deploy para produ√ß√£o
vercel --prod
```

### 4. Deploy no Google Cloud Platform

```bash
# 1. Instalar gcloud CLI
curl https://sdk.cloud.google.com | bash

# 2. Autenticar
gcloud auth login
gcloud config set project your-project-id

# 3. Build e push para Container Registry
cd backend
gcloud builds submit --tag gcr.io/your-project-id/dalivim-backend

cd ../frontend
gcloud builds submit --tag gcr.io/your-project-id/dalivim-frontend

# 4. Deploy no Cloud Run
gcloud run deploy dalivim-backend \
  --image gcr.io/your-project-id/dalivim-backend \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated

gcloud run deploy dalivim-frontend \
  --image gcr.io/your-project-id/dalivim-frontend \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated

# 5. Configurar Cloud SQL (PostgreSQL)
gcloud sql instances create dalivim-db \
  --database-version=POSTGRES_15 \
  --tier=db-f1-micro \
  --region=us-central1

# 6. Conectar Cloud Run ao Cloud SQL
gcloud run services update dalivim-backend \
  --add-cloudsql-instances your-project:us-central1:dalivim-db
```

## üîß Configura√ß√£o de Monitoramento

### Prometheus + Grafana

```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  prometheus_data:
  grafana_data:
```

### Logs Centralizados

```bash
# Ver logs de todos os containers
docker-compose logs -f

# Ver logs de um servi√ßo
docker-compose logs -f backend

# Salvar logs em arquivo
docker-compose logs > logs.txt

# Configurar logrotate
sudo nano /etc/logrotate.d/docker-dalivim
```

## üîê Backup e Recupera√ß√£o

### Backup do Banco de Dados

```bash
# Backup manual
docker-compose exec postgres pg_dump -U postgres dalivim > backup_$(date +%Y%m%d_%H%M%S).sql

# Backup automatizado (cron)
sudo crontab -e

# Adicione:
0 2 * * * docker-compose -f /var/www/dalivim/docker-compose.yml exec -T postgres pg_dump -U postgres dalivim > /backups/dalivim_$(date +\%Y\%m\%d).sql
```

### Restaurar Backup

```bash
# Restaurar backup
cat backup_20260104.sql | docker-compose exec -T postgres psql -U postgres dalivim
```

## üìä Performance Tuning

### PostgreSQL

```sql
-- postgresql.conf otimiza√ß√µes
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET default_statistics_target = 100;
ALTER SYSTEM SET random_page_cost = 1.1;
ALTER SYSTEM SET effective_io_concurrency = 200;
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET min_wal_size = '1GB';
ALTER SYSTEM SET max_wal_size = '4GB';

-- Restart PostgreSQL
SELECT pg_reload_conf();
```

### Nginx

```nginx
# nginx.conf otimiza√ß√µes
worker_processes auto;
worker_connections 1024;
keepalive_timeout 65;
gzip on;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript;
```

## üß™ Health Checks

```bash
# Criar script de health check
cat > healthcheck.sh << 'EOF'
#!/bin/bash

# Check backend
if curl -f http://localhost:8080/health > /dev/null 2>&1; then
    echo "‚úì Backend OK"
else
    echo "‚úó Backend DOWN"
    exit 1
fi

# Check PostgreSQL
if docker-compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
    echo "‚úì Database OK"
else
    echo "‚úó Database DOWN"
    exit 1
fi

# Check frontend
if curl -f http://localhost:3000 > /dev/null 2>&1; then
    echo "‚úì Frontend OK"
else
    echo "‚úó Frontend DOWN"
    exit 1
fi

echo "All services are healthy!"
EOF

chmod +x healthcheck.sh

# Executar via cron a cada 5 minutos
*/5 * * * * /var/www/dalivim/healthcheck.sh
```

## üìù Checklist de Deploy

- [ ] Vari√°veis de ambiente configuradas
- [ ] Senhas fortes geradas
- [ ] SSL/HTTPS configurado
- [ ] Firewall configurado
- [ ] Backup autom√°tico configurado
- [ ] Monitoramento ativo
- [ ] Logs centralizados
- [ ] Health checks funcionando
- [ ] CORS configurado corretamente
- [ ] Rate limiting ativo
- [ ] Dom√≠nio configurado
- [ ] DNS apontando corretamente
- [ ] Email de notifica√ß√µes (futuro)

## üÜò Troubleshooting

### Backend n√£o conecta ao PostgreSQL

```bash
# Verifique se PostgreSQL est√° rodando
docker-compose ps postgres

# Veja os logs
docker-compose logs postgres

# Teste conex√£o manual
docker-compose exec postgres psql -U postgres -d dalivim

# Verifique vari√°veis de ambiente
docker-compose exec backend env | grep DB_
```

### Frontend n√£o carrega

```bash
# Rebuild do frontend
docker-compose up -d --build frontend

# Limpe cache do navegador
# Verifique console do navegador
# Verifique network requests
```

### Alta lat√™ncia

```bash
# Verifique uso de recursos
docker stats

# Otimize PostgreSQL
# Adicione Redis cache
# Configure CDN
```

---

**Suporte**: abra uma issue no GitHub
**Documenta√ß√£o**: https://dalivim.com/docs
